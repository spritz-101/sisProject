<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <nav id="sub-nav">
        <span id="nav-title">sisProject</span>
    </nav>

    <aside id="filter-box">
        <div id="side-nav" style="margin-bottom:12px; display:flex; flex-direction:column; gap:6px;">
            <a href="index-view.html">view</a>
            <a href="index.html">dashboard</a>
            <a href="#" id="settings-btn" title="Toggle settings">settings</a>
        </div>
        <h4 id="filter-title">Filters</h4>
        <div id="filters-content" style="display:flex; flex-direction:column; gap:8px;">
            <label style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="filter-available" checked /> Available
            </label>
            <label style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="filter-low" checked /> Low stock
            </label>
        </div>
        <hr style="margin:12px 0; border:none; border-top:1px solid #ddd;" />
        <section id="settings-section" style="display:none;">
            <h4 style="display:flex;align-items:center;gap:8px; margin-top:0;">Settings</h4>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">View mode</label>
                    <button id="view-toggle" title="Toggle view">Grid</button>
                </div>
                <div>
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;">
                        <input type="checkbox" id="dark-mode-toggle" />
                        Enable AMOLED dark mode
                    </label>
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Low stock threshold</label>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span id="threshold-display">50%</span>
                        <button id="edit-threshold-btn">Change…</button>
                    </div>
                </div>
            </div>
        </section>
    </aside>
    <div id="main-content">
        <div id="top-right-controls">
            <div class="controls-left" style="display:flex; align-items:center; gap:8px;">
                <input id="search-input" type="text" placeholder="Search items..." />
                <button id="filter-toggle" title="Toggle filters">Filter</button>
            </div>
            <div class="controls-right" style="display:flex; gap:8px; align-items:center;">
                <button id="add-btn">Add item</button>
                <button id="delete-btn" disabled>Delete</button>
            </div>
        </div>
    
        <div id="items"></div>

    </div>
    
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; }
        #sub-nav { position: fixed; top: 0; left: 0; right: 0; height: 40px; display: flex; gap: 12px; align-items: center; padding: 8px 12px; background: #fff; border-bottom: 1px solid #ddd; z-index: 100; justify-content: space-between; }
        #nav-title { font-size: 1.2em; font-weight: bold; }
        #sub-nav { padding: 6px 10px; }
        
        /* Filter box: 15% width, almost reaches nav with small gap, fixed left side */
        #filter-box { position: fixed; top: 50px; left: 0; width: 15%; height: calc(100vh - 50px); padding: 20px; border-right: 1px solid #ddd; background: #fafafa; box-sizing: border-box; overflow-y: auto; }
        #filter-box h4 { margin: 0 0 8px 0; }
        
        /* Main content container */
#main-content {
    margin-left: 15%; /* sidebar width */
    padding: 1rem;     /* inner padding */
    padding-top: 9rem; /* space for nav + buttons */
    box-sizing: border-box;
}

/* Items area */
        #items {
            border: 1px solid rgb(205, 205, 205);
            padding: 1rem;
            box-sizing: border-box;
            min-height: calc(101vh - 170px);
            background: #fafafa;
            overflow: visible;
        }
        /* Grid view: smaller card columns (baby rectangle) */
        #items.grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            align-items: start;
        }
        /* List view */
        #items.list { display: block; }
        
        #top-right-controls { position: fixed; top: 75px; left: 15%; right: 12px; display: flex; justify-content: space-between; align-items: center; gap: 8px; z-index: 50; }
        #top-right-controls button { padding: 8px 10px; }
        #search-input { width: 260px; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; margin-left: 16px; }

        /* Card: pokemon-like rectangle with square image top */
        .item-box {
            border: 1px solid #333;
            border-radius: 12px;
            background: #fff;
            cursor: pointer;
            user-select: none;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            transition: box-shadow 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
            position: relative;
            overflow: hidden;
            width: 180px; /* prevent stretch */
            justify-self: start; /* align at start to keep width */
        }
        .item-card-top {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1; /* square top */
            background: #f1f1f1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 140px; /* ensure baby rectangle height */
        }
        .item-card-top img.item-thumb {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        .item-card-bottom {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        /* List layout overrides */
        #items.list .item-box { flex-direction: row; align-items: center; gap: 12px; padding: 10px; }
        #items.list .item-card-top { width: 64px; aspect-ratio: 1 / 1; border-radius: 6px; overflow: hidden; }
        #items.list .item-card-bottom { padding: 0; }
        #items.list .item-thumb { display: block; position: static; width: 100%; height: 100%; object-fit: cover; }

        .item-box:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .item-box.selected { background: #e6f0ff; border-color: #3b66ff; }
        .item-meta { font-size: 0.9em; color: #555; }
        .item-text { align-self: stretch; }
        .item-name { font-weight: 700; text-align: left; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .item-qty { text-align: left; }
        .item-badges { position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; }
        .badge { padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; color: #fff; }
        .badge.ok { background: #2e7d32; }
        .badge.low { background: #c62828; }

        /* simple modal */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal { background: #ffffff; color: #111; padding: 16px; border-radius: 8px; min-width: 300px; max-width: min(90vw, 560px); width: fit-content; margin: 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.2); border: 1px solid #ddd; }
        body.modal-open { overflow: hidden; }
        .modal label { display:block; margin-bottom:6px; font-weight:600; }
        .modal input[type="text"], .modal input[type="number"] { width:93%; padding:8px; margin-bottom:10px; }
        .modal-actions { display:flex; gap:8px; justify-content:flex-end; }

        /* AMOLED dark mode */
        body.dark-amoled { background: #000; color: #e6e6e6; }
        body.dark-amoled #sub-nav { background: #000; border-bottom-color: #222; color: #e6e6e6; }
        body.dark-amoled #filter-box { background: #000; border-right-color: #222; }
        body.dark-amoled #items { background: #000; border-color: #222; }
        body.dark-amoled .item-box { background: #0b0b0b; border-color: #222; box-shadow: none; }
        body.dark-amoled .item-card-top { background: #111; }
        body.dark-amoled .item-meta { color: #b5b5b5; }
        body.dark-amoled input, body.dark-amoled button, body.dark-amoled select { background: #0b0b0b; color: #e6e6e6; border: 1px solid #333; }
        body.dark-amoled #search-input { background: #0b0b0b; color:#e6e6e6; border-color:#333; }
        body.dark-amoled .modal { background: #0b0b0b; color: #e6e6e6; border-color: #333; }
        body.dark-amoled .badge.ok { background: #1b5e20; }
        body.dark-amoled .badge.low { background: #8e0000; }
    </style>

    <!-- Add Modal -->
    <div id="add-modal" class="modal-backdrop">
        <div class="modal">
            <h3>Add Item</h3>
            <label>Name</label>
            <input id="add-name" type="text" />
            <label>Quantity</label>
            <input id="add-qty" type="number" min="1" value="1" />
            <label>Photo (optional)</label>
            <input id="add-photo" type="file" accept="image/*" />
            <div style="display:flex;align-items:center;gap:8px;margin:6px 0 10px;">
                <img id="add-photo-preview" alt="preview" style="display:none;width:60px;height:60px;object-fit:cover;border:1px solid #ddd;border-radius:4px;" />
                <button type="button" id="add-photo-clear" style="display:none;">Remove photo</button>
            </div>

            <div id="bond-inline" style="display:none; margin:8px 0;">
                <label>Bond paper size</label>
                <select id="bond-select" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
                    <option value="">Select size…</option>
                    <option value="Letter (8.5 × 11 in | 216 × 279 mm)">Letter — 8.5 × 11 in (216 × 279 mm)</option>
                    <option value="A4 (8.27 × 11.69 in | 210 × 297 mm)">A4 — 8.27 × 11.69 in (210 × 297 mm)</option>
                    <option value="Legal (8.5 × 14 in | 216 × 356 mm)">Legal — 8.5 × 14 in (216 × 356 mm)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button id="add-cancel">Cancel</button>
                <button id="add-confirm">Add</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal-backdrop">
        <div class="modal">
            <h3>Edit Item</h3>
            <label>Name</label>
            <input id="edit-name" type="text" />
            <label>Quantity</label>
            <input id="edit-qty" type="number" min="1" />
            <label>Photo (optional)</label>
            <input id="edit-photo" type="file" accept="image/*" />
            <div style="display:flex;align-items:center;gap:8px;margin:6px 0 10px;">
                <img id="edit-photo-preview" alt="preview" style="display:none;width:60px;height:60px;object-fit:cover;border:1px solid #ddd;border-radius:4px;" />
                <button type="button" id="edit-photo-clear" style="display:none;">Remove photo</button>
            </div>
            <div class="modal-actions">
                <button id="edit-cancel">Cancel</button>
                <button id="edit-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Threshold Modal -->
    <div id="threshold-modal" class="modal-backdrop">
        <div class="modal">
            <h3>Low Stock Threshold</h3>
            <p style="margin-top:0">Set when an item shows as Low stock based on last recorded stock. Default is 50%.</p>
            <label>Threshold percentage (1-100)</label>
            <input id="threshold-input" type="number" min="1" max="100" value="50" />
            <div class="modal-actions">
                <button id="threshold-cancel">Cancel</button>
                <button id="threshold-save">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirm Modal -->
    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal">
            <h3>Confirm Delete</h3>
            <div id="confirm-text">Delete selected items?</div>
            <div class="modal-actions">
                <button id="confirm-cancel">Cancel</button>
                <button id="confirm-delete">Delete</button>
            </div>
        </div>
    </div>

    <script src="storage.js"></script>
    <script>
        let nextId = 1;
        const addBtn = document.getElementById('add-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const itemsEl = document.getElementById('items');
        const viewToggleBtn = document.getElementById('view-toggle');
        const searchInput = document.getElementById('search-input');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsSection = document.getElementById('settings-section');
        const filterTitle = document.getElementById('filter-title');
        const filtersContent = document.getElementById('filters-content');
        const darkToggle = document.getElementById('dark-mode-toggle');
        const thresholdDisplay = document.getElementById('threshold-display');
        const editThresholdBtn = document.getElementById('edit-threshold-btn');
        const filterToggleBtn = document.getElementById('filter-toggle');
        const filterAvailable = document.getElementById('filter-available');
        const filterLow = document.getElementById('filter-low');

        const addModal = document.getElementById('add-modal');
        const addName = document.getElementById('add-name');
        const addQty = document.getElementById('add-qty');
        const addConfirm = document.getElementById('add-confirm');
        const addCancel = document.getElementById('add-cancel');
        const addPhoto = document.getElementById('add-photo');
        const addPhotoPreview = document.getElementById('add-photo-preview');
        const addPhotoClear = document.getElementById('add-photo-clear');
        const bondInline = document.getElementById('bond-inline');
        const bondSelect = document.getElementById('bond-select');

        const editModal = document.getElementById('edit-modal');
        const editName = document.getElementById('edit-name');
        const editQty = document.getElementById('edit-qty');
        const editSave = document.getElementById('edit-save');
        const editCancel = document.getElementById('edit-cancel');
        const editPhoto = document.getElementById('edit-photo');
        const editPhotoPreview = document.getElementById('edit-photo-preview');
        const editPhotoClear = document.getElementById('edit-photo-clear');
        let editingId = null;

        const confirmModal = document.getElementById('confirm-modal');
        const confirmText = document.getElementById('confirm-text');
        const confirmDelete = document.getElementById('confirm-delete');
        const confirmCancel = document.getElementById('confirm-cancel');

        // Threshold modal controls
        const thresholdModal = document.getElementById('threshold-modal');
        const thresholdInput = document.getElementById('threshold-input');
        const thresholdSave = document.getElementById('threshold-save');
        const thresholdCancel = document.getElementById('threshold-cancel');

        addBtn.addEventListener('click', () => openAddModal());
        addCancel.addEventListener('click', () => closeModal(addModal));
        addConfirm.addEventListener('click', addFromModal);
        addPhoto.addEventListener('change', () => handlePhotoSelect(addPhoto, addPhotoPreview, addPhotoClear));
        addPhotoClear.addEventListener('click', () => clearPhoto(addPhoto, addPhotoPreview, addPhotoClear));
        addName.addEventListener('input', handleBondNameType);

        editCancel.addEventListener('click', () => closeModal(editModal));
        editSave.addEventListener('click', saveEdit);
        editPhoto.addEventListener('change', () => handlePhotoSelect(editPhoto, editPhotoPreview, editPhotoClear));
        editPhotoClear.addEventListener('click', () => clearPhoto(editPhoto, editPhotoPreview, editPhotoClear));

        deleteBtn.addEventListener('click', () => openConfirmModal());
        confirmCancel.addEventListener('click', () => closeModal(confirmModal));
        confirmDelete.addEventListener('click', performDelete);

        // Settings interactions
        settingsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const showing = settingsSection.style.display !== 'none';
            if (showing) {
                // hide settings, show filters
                settingsSection.style.display = 'none';
                filterTitle.style.display = '';
                filtersContent.style.display = 'flex';
            } else {
                // show settings, hide filters
                settingsSection.style.display = '';
                filterTitle.style.display = 'none';
                filtersContent.style.display = 'none';
                settingsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                settingsSection.style.boxShadow = '0 0 0 2px #3b66ff inset';
                setTimeout(() => { settingsSection.style.boxShadow = ''; }, 800);
            }
        });
        viewToggleBtn.addEventListener('click', toggleViewMode);
        editThresholdBtn.addEventListener('click', openThresholdModal);
        thresholdCancel.addEventListener('click', () => closeModal(thresholdModal));
        thresholdSave.addEventListener('click', saveThreshold);
        darkToggle.addEventListener('change', toggleDarkMode);

        searchInput.addEventListener('input', filterItems);
        filterToggleBtn.addEventListener('click', () => {
            const visible = getComputedStyle(document.getElementById('filter-box')).display !== 'none';
            // simple slide in/out by toggling width/visibility
            if (visible) {
                document.getElementById('filter-box').style.display = 'none';
                document.getElementById('main-content').style.marginLeft = '0';
                document.getElementById('top-right-controls').style.left = '12px';
            } else {
                document.getElementById('filter-box').style.display = '';
                document.getElementById('main-content').style.marginLeft = '15%';
                document.getElementById('top-right-controls').style.left = '15%';
            }
        });
        filterAvailable.addEventListener('change', filterItems);
        filterLow.addEventListener('change', filterItems);

        // initialize default view to grid (may be overridden by saved preference)
        itemsEl.classList.add('grid');

        // load persisted items
        const initialItems = SisStorage.loadItems();
        if (initialItems.length) {
            renderItems(initialItems);
            // set nextId based on max numeric id
            const maxId = initialItems.reduce((m, it) => Math.max(m, parseInt((it.id||'').replace(/^i/,''))||0), 0);
            nextId = Math.max(nextId, maxId + 1);
        }

        // Load and apply preferences
        applySavedPreferences();

        function openAddModal() {
            addName.value = '';
            addQty.value = 1;
            clearPhoto(addPhoto, addPhotoPreview, addPhotoClear);
            if (bondInline) bondInline.style.display = 'none';
            if (bondSelect) bondSelect.value = '';
            showModal(addModal);
            addName.focus();
        }

        function addFromModal() {
            let name = addName.value.trim();
            const qty = parseInt(addQty.value, 10) || 1;
            if (!name) return;
            name = toTitleCase(name);
            const photoDataUrl = addPhotoPreview.dataset.src || '';
            let meta = '';
            if (isBondPaperName(name)) {
                const val = bondSelect ? bondSelect.value : '';
                if (!val) { alert('Please select a bond paper size.'); return; }
                meta = val;
            }
            // For initial creation, lastStock defaults to qty
            createItem(name, qty, photoDataUrl, qty, meta);
            persistFromDom();
            closeModal(addModal);
        }

        function openEditModal(id) {
            const el = document.querySelector(`[data-id="${id}"]`);
            if (!el) return;
            editingId = id;
            editName.value = el.dataset.name;
            editQty.value = el.dataset.qty;
            // preload existing photo
            if (el.dataset.photo) {
                editPhotoPreview.src = el.dataset.photo;
                editPhotoPreview.style.display = 'inline-block';
                editPhotoPreview.dataset.src = el.dataset.photo;
                editPhotoClear.style.display = 'inline-block';
            } else {
                clearPhoto(editPhoto, editPhotoPreview, editPhotoClear);
            }
            showModal(editModal);
            editName.focus();
        }

        function saveEdit() {
            if (!editingId) return;
            const el = document.querySelector(`[data-id="${editingId}"]`);
            if (!el) return closeModal(editModal);
            const name = toTitleCase(editName.value.trim());
            const qty = parseInt(editQty.value, 10) || 1;
            const photoDataUrl = editPhotoPreview.dataset.src || '';
            // keep lastStock if present; otherwise initialize to qty; bump up if restocked higher
            const prevLast = parseInt(el.dataset.lastStock || qty, 10);
            const newLastStock = Math.max(prevLast, qty);
            el.dataset.name = name;
            el.dataset.qty = qty;
            el.dataset.lastStock = newLastStock;
            el.dataset.photo = photoDataUrl;
            el.querySelector('.item-name').textContent = name;
            el.querySelector('.item-qty').textContent = `Qty: ${qty}`;
            const thumb = el.querySelector('img.item-thumb');
            if (photoDataUrl) {
                thumb.src = photoDataUrl;
                thumb.style.display = 'inline-block';
            } else {
                thumb.removeAttribute('src');
                thumb.style.display = 'none';
            }
            updateAvailabilityBadge(el);
            persistFromDom();
            editingId = null;
            closeModal(editModal);
        }

        function openConfirmModal() {
            const selected = getSelectedElements();
            if (selected.length === 0) return;
            confirmText.textContent = `Delete ${selected.length} selected item(s)?`;
            showModal(confirmModal);
        }

        function performDelete() {
            const selected = getSelectedElements();
            selected.forEach(el => el.remove());
            closeModal(confirmModal);
            updateDeleteState();
            persistFromDom();
        }

        function createItem(name, qty, photoDataUrl = '', lastStock = qty, meta = '') {
            const id = `i${nextId++}`;
            const box = document.createElement('div');
            box.className = 'item-box';
            box.dataset.id = id;
            box.dataset.name = name;
            box.dataset.qty = qty;
            box.dataset.lastStock = lastStock;
            if (photoDataUrl) box.dataset.photo = photoDataUrl;
            if (meta) box.dataset.meta = meta;
            box.innerHTML = `
                <div class="item-card-top">
                    <img class="item-thumb" ${photoDataUrl ? `src="${photoDataUrl}" style="display:block;"` : ''} />
                </div>
                <div class="item-card-bottom item-text">
                    <div class="item-name">${escapeHtml(name)}</div>
                    <div class="item-meta item-qty">Qty: ${qty}</div>
                    ${meta ? `<div class=\"item-meta\">${escapeHtml(meta)}</div>` : ''}
                </div>
                <div class="item-badges"><span class="badge"></span></div>`;

            box.addEventListener('click', (e) => handleItemClick(e, box));
            box.addEventListener('dblclick', () => { openEditModal(id); });

            itemsEl.appendChild(box);
            updateAvailabilityBadge(box);
            updateDeleteState();
        }

        function handleItemClick(e, el) {
            const multi = e.ctrlKey || e.metaKey;
            if (multi) {
                el.classList.toggle('selected');
            } else {
                const others = itemsEl.querySelectorAll('.item-box.selected');
                others.forEach(o => { if (o !== el) o.classList.remove('selected'); });
                el.classList.toggle('selected');
            }
            updateDeleteState();
        }

        function getSelectedElements() {
            return Array.from(itemsEl.querySelectorAll('.item-box.selected'));
        }

        function updateDeleteState() {
            const selected = getSelectedElements();
            // Only consider visible selected items for delete
            const anyVisibleSelected = selected.some(el => el.style.display !== 'none');
            deleteBtn.disabled = !anyVisibleSelected;
        }

        function filterItems() {
            const q = (searchInput.value || '').trim().toLowerCase();
            const showAvail = !!filterAvailable.checked;
            const showLow = !!filterLow.checked;
            const boxes = itemsEl.querySelectorAll('.item-box');
            boxes.forEach(box => {
                const name = (box.dataset.name || '').toLowerCase();
                const meta = (box.dataset.meta || '').toLowerCase();
                const qty = parseInt(box.dataset.qty, 10) || 0;
                const last = parseInt(box.dataset.lastStock || qty, 10);
                const threshold = getLowStockThreshold();
                const isLow = last > 0 && qty < threshold * last;
                const isAvail = !isLow;
                const textMatch = `${name} ${meta} qty: ${qty}`.includes(q);
                const statusMatch = (isLow && showLow) || (isAvail && showAvail);
                box.style.display = textMatch && statusMatch ? '' : 'none';
            });
            updateDeleteState();
        }

        function toggleViewMode() {
            const isGrid = itemsEl.classList.contains('grid');
            if (isGrid) {
                itemsEl.classList.remove('grid');
                itemsEl.classList.add('list');
                viewToggleBtn.textContent = 'List';
                localStorage.setItem('viewMode', 'list');
            } else {
                itemsEl.classList.remove('list');
                itemsEl.classList.add('grid');
                viewToggleBtn.textContent = 'Grid';
                localStorage.setItem('viewMode', 'grid');
            }
        }

        function updateAvailabilityBadge(el) {
            const qty = parseInt(el.dataset.qty, 10) || 0;
            const last = parseInt(el.dataset.lastStock || qty, 10);
            const badge = el.querySelector('.badge');
            if (!badge) return;
            const threshold = getLowStockThreshold();
            if (last > 0 && qty < threshold * last) {
                badge.textContent = 'Low stock';
                badge.classList.add('low');
                badge.classList.remove('ok');
            } else {
                badge.textContent = 'Available';
                badge.classList.add('ok');
                badge.classList.remove('low');
            }
        }

        function showModal(modal) { modal.style.display = 'flex'; document.body.classList.add('modal-open'); }
        function closeModal(modal) { modal.style.display = 'none'; document.body.classList.remove('modal-open'); }

        function openThresholdModal() {
            const pct = Math.round(getLowStockThreshold() * 100);
            thresholdInput.value = pct;
            showModal(thresholdModal);
        }
        function saveThreshold() {
            const v = Math.max(1, Math.min(100, parseInt(thresholdInput.value, 10) || 50));
            if (!confirm(`Update low stock threshold to ${v}%?`)) return; // second confirmation
            setLowStockThreshold(v / 100);
            thresholdDisplay.textContent = `${v}%`;
            // re-evaluate badges
            const boxes = itemsEl.querySelectorAll('.item-box');
            boxes.forEach(updateAvailabilityBadge);
            closeModal(thresholdModal);
        }

        function toggleDarkMode() {
            const enabled = !!darkToggle.checked;
            if (enabled) {
                document.body.classList.add('dark-amoled');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-amoled');
                localStorage.setItem('theme', 'light');
            }
        }

        function getLowStockThreshold() {
            const v = parseFloat(localStorage.getItem('lowStockThreshold'));
            return isNaN(v) ? 0.5 : Math.min(0.99, Math.max(0.01, v));
        }
        function setLowStockThreshold(v) {
            localStorage.setItem('lowStockThreshold', String(v));
        }
        function applySavedPreferences() {
            // theme
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') { document.body.classList.add('dark-amoled'); darkToggle.checked = true; }
            // view mode
            const vm = localStorage.getItem('viewMode') || 'grid';
            if (vm === 'list') { itemsEl.classList.remove('grid'); itemsEl.classList.add('list'); viewToggleBtn.textContent = 'List'; }
            else { itemsEl.classList.add('grid'); itemsEl.classList.remove('list'); viewToggleBtn.textContent = 'Grid'; }
            // threshold display
            const pct = Math.round(getLowStockThreshold() * 100);
            thresholdDisplay.textContent = `${pct}%`;
        }

        function isBondPaperName(name) {
            return /\bbond\s*paper\b/i.test(name);
        }
        function handleBondNameType() {
            const isBond = isBondPaperName(addName.value);
            if (bondInline) bondInline.style.display = isBond ? 'block' : 'none';
            if (!isBond && bondSelect) bondSelect.value = '';
        }

        function handlePhotoSelect(input, previewImg, clearBtn) {
            const [file] = input.files;
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                previewImg.src = e.target.result;
                previewImg.dataset.src = e.target.result;
                previewImg.style.display = 'inline-block';
                clearBtn.style.display = 'inline-block';
            };
            reader.readAsDataURL(file);
        }
        function clearPhoto(input, previewImg, clearBtn) {
            input.value = '';
            delete previewImg.dataset.src;
            previewImg.removeAttribute('src');
            previewImg.style.display = 'none';
            clearBtn.style.display = 'none';
        }

        function escapeHtml(s) { return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }
        function toTitleCase(s) { return s.replace(/\w\S*/g, t => t.charAt(0).toUpperCase() + t.slice(1).toLowerCase()); }

        // persistence
        function serializeFromDom() {
            const boxes = Array.from(itemsEl.querySelectorAll('.item-box'));
            return boxes.map(b => ({
                id: b.dataset.id,
                name: b.dataset.name,
                qty: parseInt(b.dataset.qty,10)||0,
                lastStock: parseInt(b.dataset.lastStock,10)||0,
                photoDataUrl: b.dataset.photo || '',
                meta: b.dataset.meta || ''
            }));
        }
        function renderItems(items) {
            itemsEl.innerHTML = '';
            items.forEach(it => {
                const idStr = it.id && /^i\d+$/.test(it.id) ? it.id : `i${nextId++}`;
                // ensure nextId keeps increasing if using provided id
                const n = parseInt(idStr.replace(/^i/, ''))||0; nextId = Math.max(nextId, n+1);
                createItem(it.name || '', parseInt(it.qty,10)||0, it.photoDataUrl||'', parseInt(it.lastStock,10)||0, it.meta||'');
                const box = itemsEl.lastElementChild;
                box.dataset.id = idStr;
            });
            updateDeleteState();    
        }
        function persistFromDom() {
            const items = serializeFromDom();
            SisStorage.saveItems(items);
        }

        // small demo items

    </script>
</body>
</html>