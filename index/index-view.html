<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <nav id="sub-nav">
        <span id="nav-title">sisProject</span>
    </nav>

    <aside id="filter-box">
        <div id="side-nav" style="margin-bottom:12px; display:flex; flex-direction:column; gap:6px;">
            <a href="index-view.html">view</a>
            <a href="index.html">dashboard</a>
            <a href="#" id="settings-btn" title="Toggle settings">settings</a>
        </div>
        <h4 id="filter-title">Filters</h4>
        <div id="filters-content" style="display:flex; flex-direction:column; gap:8px;">
            <label style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="filter-available" checked /> Available
            </label>
            <label style="display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="filter-low" checked /> Low stock
            </label>
        </div>
        <hr style="margin:12px 0; border:none; border-top:1px solid #ddd;" />
        <section id="settings-section" style="display:none;">
            <h4 style="display:flex;align-items:center;gap:8px; margin-top:0;">Settings</h4>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">View mode</label>
                    <button id="view-toggle" title="Toggle view">Grid</button>
                </div>
                <div>
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;">
                        <input type="checkbox" id="dark-mode-toggle" />
                        Enable AMOLED dark mode
                    </label>
                </div>
                <div>
                    <label style="display:block; font-weight:600; margin-bottom:4px;">Low stock threshold</label>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span id="threshold-display">50%</span>
                        <button id="edit-threshold-btn">Changeâ€¦</button>
                    </div>
                </div>
            </div>
        </section>
    </aside>

    <div id="main-content">
        <div id="top-right-controls">
            <div class="controls-left" style="display:flex; align-items:center; gap:8px;">
                <input id="search-input" type="text" placeholder="Search items..." />
                <button id="filter-toggle" title="Toggle filters">Filter</button>
            </div>
            <div class="controls-right" style="display:flex; gap:8px; align-items:center;"></div>
        </div>
        <div id="items"></div>
    </div>

    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; }
        #sub-nav { position: fixed; top: 0; left: 0; right: 0; height: 40px; display: flex; gap: 12px; align-items: center; padding: 8px 12px; background: #fff; border-bottom: 1px solid #ddd; z-index: 100; justify-content: space-between; }
        #nav-title { font-size: 1.2em; font-weight: bold; }
        
        /* Filter box and main layout (duplicated from index.html) */
        #filter-box { position: fixed; top: 50px; left: 0; width: 15%; height: calc(100vh - 50px); padding: 20px; border-right: 1px solid #ddd; background: #fafafa; box-sizing: border-box; overflow-y: auto; }
        #filter-box h4 { margin: 0 0 8px 0; }
        #main-content { margin-left: 15%; padding: 1rem; padding-top: 9rem; box-sizing: border-box; }
        #top-right-controls { position: fixed; top: 75px; left: 15%; right: 12px; display: flex; justify-content: space-between; align-items: center; gap: 8px; z-index: 50; }
        #search-input { width: 260px; padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; margin-left: 16px; }

        /* Items area */
        #items { border: 1px solid #cdcdcd; padding: 1rem; background: #fafafa; min-height: calc(101vh - 170px); overflow: visible; }
        #items.grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; align-items: start; }
        #items.list { display: block; }
        .card { border: 1px solid #333; border-radius: 12px; background: #fff; display: flex; flex-direction: column; gap: 6px; position: relative; width: 180px; justify-self: start; overflow: hidden; }
        .thumb-wrap { width: 100%; aspect-ratio: 1/1; background: #f1f1f1; display: flex; align-items: center; justify-content: center; min-height: 140px; overflow: hidden; }
        .thumb { width: 100%; height: 100%; object-fit: cover; display: none; }
        .name { font-weight: 700; padding: 8px 10px 0; }
        .meta { color: #555; font-size: 0.9em; padding: 0 10px 8px; }
        /* List layout overrides */
        #items.list .card { flex-direction: row; align-items: center; gap: 12px; width: auto; }
        #items.list .thumb-wrap { width: 64px; min-height: 64px; aspect-ratio: 1 / 1; border-radius: 6px; overflow: hidden; }
        #items.list .name { padding: 0 10px 0; }
        #items.list .meta { padding: 0 10px 0; }
        #items.list .badges { position: static; margin-left: auto; }
        .badges { position: absolute; top: 8px; right: 8px; }
        .badge { padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; color: #fff; }
        .ok { background: #2e7d32; }
        .low { background: #c62828; }
        body.modal-open { overflow: hidden; }

        /* AMOLED dark mode */
        body.dark-amoled { background: #000; color: #e6e6e6; }
        body.dark-amoled #sub-nav { background: #000; border-bottom-color: #222; color: #e6e6e6; }
        body.dark-amoled #filter-box { background: #000; border-right-color: #222; }
        body.dark-amoled #items { background: #000; border-color: #222; }
        body.dark-amoled .card { background: #0b0b0b; border-color: #222; box-shadow: none; }
        body.dark-amoled .meta { color: #b5b5b5; }
        body.dark-amoled input, body.dark-amoled button, body.dark-amoled select { background: #0b0b0b; color: #e6e6e6; border: 1px solid #333; }
        body.dark-amoled #search-input { background: #0b0b0b; color:#e6e6e6; border-color:#333; }
        body.dark-amoled .badge.ok { background: #1b5e20; }
        body.dark-amoled .badge.low { background: #8e0000; }
    </style>

    <script>
    const STORAGE_KEY = 'sis.items.v1';
    const itemsEl = document.getElementById('items');

    // Settings and filter DOM nodes
    const settingsBtn = document.getElementById('settings-btn');
    const settingsSection = document.getElementById('settings-section');
    const filterTitle = document.getElementById('filter-title');
    const filtersContent = document.getElementById('filters-content');
    const filterToggleBtn = document.getElementById('filter-toggle');
    const searchInput = document.getElementById('search-input');
    const filterAvailable = document.getElementById('filter-available');
    const filterLow = document.getElementById('filter-low');
    const darkToggle = document.getElementById('dark-mode-toggle');
    const thresholdDisplay = document.getElementById('threshold-display');
    const editThresholdBtn = document.getElementById('edit-threshold-btn');
    const viewToggleBtn = document.getElementById('view-toggle');

    function loadItems() {
        try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return [];
            const arr = JSON.parse(raw);
            return Array.isArray(arr) ? arr : [];
        } catch { return []; }
    }

    function shouldShow(item, qtext) {
        const name = (item.name || '').toLowerCase();
        const meta = (item.meta || '').toLowerCase();
        const q = parseInt(item.qty,10)||0;
        const last = parseInt(item.lastStock,10)||0;
        const threshold = getLowStockThreshold();
        const isLow = last > 0 && q < threshold * last;
        const isAvail = !isLow;
        const textMatch = `${name} ${meta} qty: ${q}`.includes(qtext);
        const statusMatch = (isLow && filterLow.checked) || (isAvail && filterAvailable.checked);
        return textMatch && statusMatch;
    }

    function render() {
        const items = loadItems();
        itemsEl.innerHTML = '';
        const qtext = (searchInput?.value || '').trim().toLowerCase();
        items.forEach(it => {
            if (!shouldShow(it, qtext)) return;
            const card = document.createElement('div');
            card.className = 'card';
            const top = document.createElement('div');
            top.className = 'thumb-wrap';
            const img = document.createElement('img');
            img.className = 'thumb';
            if (it.photoDataUrl) { img.src = it.photoDataUrl; img.style.display = 'block'; }
            const name = document.createElement('div');
            name.className = 'name';
            name.textContent = it.name || '';
            const qty = document.createElement('div');
            qty.className = 'meta';
            qty.textContent = `Qty: ${parseInt(it.qty,10)||0}`;
            const extra = document.createElement('div');
            extra.className = 'meta';
            extra.textContent = it.meta || '';
            const badgeWrap = document.createElement('div');
            badgeWrap.className = 'badges';
            const b = document.createElement('span');
            const last = parseInt(it.lastStock,10)||0;
            const q = parseInt(it.qty,10)||0;
            if (last > 0 && q < getLowStockThreshold()*last) { b.className = 'badge low'; b.textContent = 'Low stock'; }
            else { b.className = 'badge ok'; b.textContent = 'Available'; }
            badgeWrap.appendChild(b);
            top.appendChild(img);
            card.appendChild(top);
            card.appendChild(name);
            card.appendChild(qty);
            if (it.meta) card.appendChild(extra);
            card.appendChild(badgeWrap);
            itemsEl.appendChild(card);
        });
    }

    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') render();
    });
    window.addEventListener('storage', (e) => { if (e.key === STORAGE_KEY) render(); });

    // preferences and handlers duplicated from index.html
    function getLowStockThreshold() {
        const v = parseFloat(localStorage.getItem('lowStockThreshold'));
        return isNaN(v) ? 0.5 : Math.min(0.99, Math.max(0.01, v));
    }
    function setLowStockThreshold(v) { localStorage.setItem('lowStockThreshold', String(v)); }

    function applySavedPreferences() {
        // theme
        const theme = localStorage.getItem('theme') || 'light';
        if (theme === 'dark') { document.body.classList.add('dark-amoled'); const dm = document.getElementById('dark-mode-toggle'); if (dm) dm.checked = true; }
        // view mode
        const vm = localStorage.getItem('viewMode') || 'grid';
        itemsEl.classList.remove('grid','list');
        if (vm === 'list') { itemsEl.classList.add('list'); if (viewToggleBtn) viewToggleBtn.textContent = 'List'; }
        else { itemsEl.classList.add('grid'); if (viewToggleBtn) viewToggleBtn.textContent = 'Grid'; }
        // threshold display
        const pct = Math.round(getLowStockThreshold() * 100);
        const td = document.getElementById('threshold-display'); if (td) td.textContent = `${pct}%`;
    }

    function openThresholdModal() {
        const pct = Math.round(getLowStockThreshold() * 100);
        const input = document.getElementById('threshold-input');
        if (input) input.value = pct;
        const modal = document.getElementById('threshold-modal');
        if (modal) { modal.style.display = 'flex'; document.body.classList.add('modal-open'); }
    }
    function closeModal(modal) { modal.style.display = 'none'; document.body.classList.remove('modal-open'); }

    function toggleViewMode() {
        const isGrid = itemsEl.classList.contains('grid');
        if (isGrid) {
            itemsEl.classList.remove('grid');
            itemsEl.classList.add('list');
            if (viewToggleBtn) viewToggleBtn.textContent = 'List';
            localStorage.setItem('viewMode', 'list');
        } else {
            itemsEl.classList.remove('list');
            itemsEl.classList.add('grid');
            if (viewToggleBtn) viewToggleBtn.textContent = 'Grid';
            localStorage.setItem('viewMode', 'grid');
        }
        render();
    }

    // mount handlers after DOM ready
    window.addEventListener('DOMContentLoaded', () => {
        applySavedPreferences();
        const dm = document.getElementById('dark-mode-toggle');
        if (dm) dm.addEventListener('change', () => {
            if (dm.checked) { document.body.classList.add('dark-amoled'); localStorage.setItem('theme','dark'); }
            else { document.body.classList.remove('dark-amoled'); localStorage.setItem('theme','light'); }
        });
        const sb = document.getElementById('settings-btn');
        if (sb) sb.addEventListener('click', (e) => {
            e.preventDefault();
            const sec = document.getElementById('settings-section');
            const ft = document.getElementById('filter-title');
            const fc = document.getElementById('filters-content');
            const showing = sec.style.display !== 'none';
            if (showing) {
                sec.style.display = 'none';
                ft.style.display = '';
                fc.style.display = 'flex';
            } else {
                sec.style.display = '';
                ft.style.display = 'none';
                fc.style.display = 'none';
                sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
                sec.style.boxShadow = '0 0 0 2px #3b66ff inset';
                setTimeout(() => { sec.style.boxShadow = ''; }, 800);
            }
        });
        const ftb = document.getElementById('filter-toggle');
        if (ftb) ftb.addEventListener('click', () => {
            const fb = document.getElementById('filter-box');
            const visible = getComputedStyle(fb).display !== 'none';
            if (visible) {
                fb.style.display = 'none';
                document.getElementById('main-content').style.marginLeft = '0';
                document.getElementById('top-right-controls').style.left = '12px';
            } else {
                fb.style.display = '';
                document.getElementById('main-content').style.marginLeft = '15%';
                document.getElementById('top-right-controls').style.left = '15%';
            }
        });
        const fAvail = document.getElementById('filter-available');
        const fLow = document.getElementById('filter-low');
        if (fAvail) fAvail.addEventListener('change', render);
        if (fLow) fLow.addEventListener('change', render);
        if (searchInput) searchInput.addEventListener('input', render);
        const etb = document.getElementById('edit-threshold-btn');
        if (etb) etb.addEventListener('click', openThresholdModal);
        const tCancel = document.getElementById('threshold-cancel');
        if (tCancel) tCancel.addEventListener('click', () => closeModal(document.getElementById('threshold-modal')));
        const tSave = document.getElementById('threshold-save');
        if (tSave) tSave.addEventListener('click', () => {
            const input = document.getElementById('threshold-input');
            const v = Math.max(1, Math.min(100, parseInt(input.value, 10) || 50));
            if (!confirm(`Update low stock threshold to ${v}%?`)) return;
            setLowStockThreshold(v/100);
            const td = document.getElementById('threshold-display'); if (td) td.textContent = `${v}%`;
            render();
            closeModal(document.getElementById('threshold-modal'));
        });
        const vtb = document.getElementById('view-toggle');
        if (vtb) vtb.addEventListener('click', toggleViewMode);
        render();
    });
    </script>

    <!-- Threshold Modal duplicated -->
    <div id="threshold-modal" class="modal-backdrop" style="display:none; align-items:center; justify-content:center; position:fixed; inset:0; background: rgba(0,0,0,0.35); z-index:2000;">
        <div class="modal" style="background:#ffffff; color:#111; padding:16px; border-radius:8px; min-width:300px; max-width:min(90vw,560px); width:fit-content; margin:16px; box-shadow:0 6px 24px rgba(0,0,0,0.2); border:1px solid #ddd;">
            <h3>Low Stock Threshold</h3>
            <p style="margin-top:0">Set when an item shows as Low stock based on last recorded stock. Default is 50%.</p>
            <label>Threshold percentage (1-100)</label>
            <input id="threshold-input" type="number" min="1" max="100" value="50" style="width:93%; padding:8px; margin-bottom:10px;" />
            <div class="modal-actions" style="display:flex; gap:8px; justify-content:flex-end;">
                <button id="threshold-cancel">Cancel</button>
                <button id="threshold-save">Save</button>
            </div>
        </div>
    </div>
</body>
</html>